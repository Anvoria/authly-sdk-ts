name: Publish to npm

on:
    push:
        tags:
            - "v*"

jobs:
    publish:
        name: Publish to npm
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Set project version
              run: |
                  VERSION=${{ github.ref_name }}
                  bun -e "const fs = require('fs'); const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8')); pkg.version = process.argv[1].replace(/^v/, ''); fs.writeFileSync('package.json', JSON.stringify(pkg, null, 4) + '\n');" "${VERSION}"

            - name: Build package
              run: bun run build

            - name: Publish to npm
              run: bun publish --tolerate-republish
